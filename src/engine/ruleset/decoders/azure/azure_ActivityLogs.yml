name: decoder/azure_ActivityLogs/0

sources: 
  - decoder/azure_base_decoder/0

metadata:
  description: ActivityLog decoder for Azure events
  module: Azure
  compatibility: >
    This decoder has been tested on Wazuh version 4.3
  author:
    name: Wazuh, Inc.
    date: 2023/02/14
  title: This decoder normalizes basic field from Azure ActivityLogs
  references:
    - https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/platform-logs-overview

check:
   - ~json.Type: AzureActivity

normalize:
  - map:
    - azure.resource_id: $~json.ResourceId
    - log.level: $~json.Level
    - event.duration: $~json.DurationMs
    - azure.activitylogs.properties: +parse_json/$~json.Properties
    - event.outcome: $~json.ResultType
    - event.outcome: $azure.activitylogs.properties.result
    - azure.activitylogs.operation_name: $~json.OperationName
    - event.action: $azure.activitylogs.operation_name
    - azure.activitylogs.operation_version: $~json.OperationVersion
    - azure.activitylogs.tenant_id: $~json.TenantId
    - azure.activitylogs.level: $log.level
    - azure.activitylogs.result_signature: $~json.ResultSignature

  - logpar:
    - ~json.CallerIpAddress: <source.ip>:<source.port>
    - ~json.CallerIpAddress: "[<source.ip>]:<source.port>"
    - ~json.CallerIpAddress: <source.ip>

  - map:  
    - client.ip: $source.ip
    - related.ip: $source.ip


  - check: $azure.activitylogs.properties.EventCategory
    map:
     - azure.activitylogs.event_category: $azure.activitylogs.properties.eventCategory

  - check: NOT $azure.activitylogs.properties.EventCategory AND $azure.activitylogs.Policies
    map:
     - azure.activitylogs.event_category: Policy

  - check: NOT $azure.activitylogs.properties.EventCategory AND NOT $azure.activitylogs.Policies
    map:
     - azure.activitylogs.event_category: Administrative